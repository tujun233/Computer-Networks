# IP协议
## 网络层
网络层的下一层——数据链路层的主要作用是在互连同一种数据链路的节点之间进行包传递。而一旦跨越多种数据链路，就需要借助网络层。网络层可以跨越不同的数据链路，即使是在不同的数据链路上也能实现两端节点之间的数据包传输

<img src=".//4/1.png" width="80%">

## IP基础知识
### 路由控制
路由控制（Routing）是指将分组数据发送到最终目标地址的功能。即使网络非常复杂，也可以通过路由控制确定到达目标地址的通路。一旦这个路由控制的运行出现异常，分组数据极有可能“迷失”，无法到达目标地址。因此，一个数据包之所以能够成功地到达最终的目标地址，全靠路由控制。

为了将数据包发给目标主机，所有主机都维护着一张路由**控制表**（Routing Table）。该表记录IP数据在下一步应该发给哪个路由器。IP包将根据这个路由表在各个数据链路上传输。

<img src=".//4/2.png" width="80%">

### 数据链路的抽象化
不同数据链路有个最大的区别，就是它们各自的最大传输单位（MTU：Maximum Transmission Unit）不同。就好像人们在邮寄包裹或行李时有各自的大小限制一样。

MTU的值在以太网中是1500字节，在FDDI中是4352字节，而ATM则为9180字节。IP的上一层可能会要求传送比这些MTU更多字节的数据，因此必须在线路上传送比MTU还要小的包长。

为了解决这个问题，IP进行分片处理（IP Fragmentation）。顾名思义，所谓分片处理是指，将较大的IP包分成多个较小的IP包。分片的包到了对端目标地址以后会再被组合起来传给上一层。即从IP的上次层看，它完全可以忽略数据包在途中的各个数据链路上的MTU，而只需要按照源地址发送的长度接收数据包。

### IP属于面向无连接型
IP面向**无连接**。即在发包之前，不需要建立与对端目标地址之间的连接。上层如果遇到需要发送给IP的数据，该数据会立即被压缩成IP包发送出去。在面向有连接的情况下，需要事先建立连接。如果对端主机关机或不存在，也就不可能建立连接。反之，一个没有建立连接的主机也不可能发送数据过来。而面向无连接的情况则不同。即使对端主机关机或不存在，数据包还是会被发送出去。反之，对于一台主机来说，它会何时从哪里收到数据也是不得而知的。

为什么IP要采用面向无连接呢？主要有两点原因：一是为了**简化**，二是为了**提速**。面向连接比起面向无连接处理相对复杂。甚至管理每个连接本身就是一个相当繁琐的事情。此外，每次通信之前都要事先建立连接，又会降低处理速度。需要有连接时，可以委托上一层提供此项服务。因此，IP为了实现简单化与高速化采用面向无连接的方式。

## IP地址
### IP地址定义
IP地址（IPv4地址）由32位正整数来表示。TCP/IP通信要求将这样的IP地址分配给每一个参与通信的主机。IP地址在计算机内部以二进制方式被处理。然而，由于人类社会并不习惯于采用二进制方式，需要采用一种特殊的标记方式。那就是将32位的IP地址以每8位为一组，分成4组，每组以“.”隔开，再将每组数转换为十进制数。下面举例说明这一方法。

<img src=".//4/3.png" width="80%">

### IP地址组成
IP地址由**网络标识**和**主机标识**两部分组成。网络标识在数据链路的每个段配置不同的值。网络标识必须保证相互连接的每个段的地址不相重复。而相同段内相连的主机必须有相同的网络地址。IP地址的“主机标识”则不允许在同一个网段内重复出现。由此，可以通过设置网络地址和主机地址，在相互连接的整个网络中保证每台主机的IP地址都不会相互重叠。即IP地址具有了唯一性。

<img src=".//4/4.png" width="80%">

### IP地址分类
IP地址分为四个级别，分别为A类、B类、C类、D类（还有一个一直未使用的E类。） 。它根据IP地址中从第1位到第4位的比特列对其网络标识和主机标识进行区分。

**A类IP地址**是首位以“0”开头的地址。从第1位到第8位（去掉分类位剩下7位。） 是它的网络标识。用十进制表示的话，0.0.0.0～127.0.0.0是A类的网络地址。A类地址的后24位相当于主机标识。因此，一个网段内可容纳的主机地址上限为16777214个。

**B类IP地址**是前两位为“10”的地址。从第1位到第16位（去掉分类位剩下14位。） 是它的网络标识。用十进制表示的话，128.0.0.1～191.255.0.0是B类的网络地址。B类地址的后16位相当于主机标识。因此，一个网段内可容纳的主机地址上限为65，534个。

**C类IP地址**是前三位为“110”的地址。从第1位到第24位（去掉分类位剩下21位。） 是它的网络标识。用十进制表示的话，192.168.0.0～239.255.255.0是C类的网络地址。C类地址的后8位相当于主机标识。因此，一个网段内可容纳的主机地址上限为254个

**D类IP地址**是前四位为“1110”的地址。从第1位到第32位（去掉分类位剩下28位。） 是它的网络标识。用十进制表示的话，224.0.0.0～239.255.255.255是D类的网络地址。D类地址没有主机标识，常被用于多播。

在分配IP地址时关于主机标识有一点需要注意。即要用比特位表示主机地址时，不可以全部为0或全部为1。因为全部为只有0在表示对应的网络地址或IP地址不可获知的情况下才使用。而全部为1的主机地址通常作为**广播地址**。

<img src=".//4/5.png" width="80%">

### 广播地址
广播地址用于在同一个链路中相互连接的主机之间发送数据包。将IP地址中的主机地址部分全部设置为1，就成为了广播地址（以太网中如果将MAC地址的所有位都改为1，则形成FF：FF：FF：FF：FF：FF的广播地址。因此，广播的IP包以数据链路的帧的形式发送时，得通过MAC地址为全1比特的FF：FF：FF：FF：FF：FF转发。）

广播分为本地广播和直接广播两种。

在本网络内的广播叫做**本地广播**。例如网络地址为192.168.0.0/24的情况下，广播地址是192.168.0.255。因为这个广播地址的IP包会被路由器屏蔽，所以不会到达192.168.0.0/24以外的其他链路上。

在不同网络之间的广播叫做**直接广播**。例如网络地址为192.168.0.0/24的主机向192.168.1.255/24的目标地址发送IP包。收到这个包的路由器，将数据转发给192.168.1.0/24，从而使得所有192.168.1.1～192.168.1.254的主机都能收到这个包（由于直接广播有一定的安全问题，多数情况下会在路由器上设置为不转发。）。

### IP多播
多播用于将包发送给特定组内的所有主机。由于其直接使用IP协议，因此也不存在可靠传输。而随着多媒体应用的发展，对于向多台主机同时发送数据包，在效率上的要求也日益提高。在电视会议系统中对于1对N、N对N通信的需求明显上升。而具体实现上往往采用复制1对1通信的数据，将其同时发送给多个主机的方式。

在人们使用多播功能之前，一直采用广播的方式。那时广播将数据发给所有终端主机，再由这些主机IP之上的一层去判断是否有必要接收数据。是则接收，否则丢弃。然而这种方式会给那些毫无关系的网络或主机带来影响，造成网络上很多不必要的流量。况且由于广播无法穿透路由，若想给其他网段发送同样的包，就不得不采取另一种机制。因此，多播这种既可以穿透路由器，又可以实现只给那些必要的组发送数据包的技术就成为必选之路了。

<img src=".//4/6.png" width="80%">

多播使用D类地址。因此，如果从首位开始到第4位是“1110”，就可以认为是多播地址。而剩下的28位可以成为多播的组编号。

从224.0.0.0到239.255.255.255都是多播地址的可用范围。其中从224.0.0.0到224.0.0.255的范围不需要路由控制，在同一个链路内也能实现多播。而在这个范围之外设置多播地址会给全网所有组内成员发送多播的包（可以利用生存时间（TTL，Time To Live）限制包的到达范围。）。

此外，对于多播，所有的主机（路由器以外的主机和终端主机）必须属于224.0.0.1的组，所有的路由器必须属于224.0.0.2的组。类似地，多播地址中有众多已知的地址。

利用IP多播实现通信，除了地址外还需要IGMP（Internet Group Management Protocol） 等协议的支持。

### 子网掩码
现在，一个IP地址的网络标识和主机标识已不再受限于该地址的类别，而是由一个叫做**子网掩码**的识别码通过子网网络地址细分出比A类、B类、C类更小粒度的网络。这种方式实际上就是将原来A类、B类C类等分类中的主机地址部分用作子网地址，可以将原网络分为多个物
理网络的一种机制。

自从引入了子网以后，一个IP地址就有了两种识别码。一是IP地址本身，另一个是表示网络部的子网掩码。子网掩码用二进制方式表示的话，也是一个32位的数字。它对应IP地址网络标识部分的位全部为“1”，对应IP地址主机标识的部分则全部为“0”。由此，一个IP地址可以不再受限于自己的类别，而是可以用这样的子网掩码自由地定位自己的网络标识长度。当然，子网掩码必须是IP地址的首位开始连续的“1”

<img src=".//4/7.png" width="80%">

### CIDR与VLSM
采用任意长度分割IP地址的网络标识和主机标识。这种方式叫做CIDR，意为“无类型域间选路”。

根据CIDR，连续多个C类地址（CIDR汇总的C类地址以2的幂次（4，8，16，32，……）划分，因此必须有一个能够按位分割的边界。）就可以划分到一个较大的网络内。CIDR更有效地利用了当前IPv4地址，同时通过路由集中降低了路由器的负担。

<img src=".//4/8.png" width="80%">

一种可以随机修改组织内各个部门的子网掩码长度的机制——VLSM（可变长子网掩码）（Variable Length Subnet Mask）。它可以通过域间路由协议转换为RIP2以及OSPF实现。根据VLSM可以将网络地址划分为主机数为500个时子网掩码长度为/23，主机数为50个时子网掩码长度为/26。从而在理论上可以将IP地址的利用率提高至50％。

### 全局地址与私有地址
然而，随着互联网的迅速普及，IP地址不足的问题日趋显著。如果一直按照现行的方法采用唯一地址的话，会有IP地址耗尽的危险。

于是就出现了一种新技术。它不要求为每一台主机或路由器分配一个固定的IP地址，而是在必要的时候只为相应数量的设备分配唯一的IP地址。

尤其对于那些没有连接互联网的独立网络中的主机，只要保证在这个网络内地址唯一，可以不用考虑互联网即可配置相应的IP地址。不过，即使让每个独立的网络各自随意地设置IP地址，也可能会有问题（例如因运维方案发生变化该网络需要连接到互联网时，或者不小心误被连接到了互联网时，再例如连接两个本来就各自独立的网络时，都容易发生地址冲突。）。于是又出现了私有网络的IP地址。

<img src=".//4/9.png" width="80%">

包含在这个范围内的IP地址都属于私有IP，而在此之外（A类～C类范围中除去0/8、127/8。）的IP地址称为全局IP（也叫公网IP。）。

私有IP最早没有计划连接互联网，而只用于互联网之外的独立网络。然而，当一种能够互换私有IP与全局IP的NAT技术诞生以后，配有私有地址的主机与配有全局地址的互联网主机实现了通信。

## 路由控制
发送数据包时所使用的地址是网络层的地址，即IP地址。然而仅仅有IP地址还不足以实现将数据包发送到对端目标地址，在数据发送过程中还需要类似于“指明路由器或主机”的信息，以便真正发往目标地址。保存这种信息的就是**路由控制表**（Routing Table）。实现IP通信的主机和路由器都必须持有一张这样的表。它们也正是在这个表格的基础上才得以进行数据包发送的。

该路由控制表的形成方式有两种：一种是管理员手动设置，另一种是路由器与其他路由器相互交换信息时自动刷新。前者也叫静态路由控制，而后者叫做动态路由控制。为了让动态路由及时刷新路由表，在网络上互连的路由器之间必须设置好路由协议，保证正常读取路由控制信息。

<img src=".//4/10.png" width="80%">

#### 默认路由
如果一张路由表中包含所有的网络及其子网的信息，将会造成无端的浪费。这时，默认路由（Default Route）是不错的选择。默认路由是指路由表中任何一个地址都能与之匹配的记录。

默认路由一般标记为0.0.0.0/0或default（表示子网掩码时，IP地址为0.0.0.0，子网掩码也是0.0.0.0。）。这里的0.0.0.0/0并不是指IP地址是0.0.0.0。由于后面是“/0”，所以并没有标识IP地址（0.0.0.0的IP地址应该记述为0.0.0.0/32。）。它只是为了避免人们误以为0.0.0.0是IP地址。有时默认路由也被标记为default，但是在计算机内部和路由协议的发送过程中还是以0.0.0.0/0进行处理。

#### 主机路由
“IP地址/32”也被称为主机路由（Host Route）。例如，192.168.153.15/32（表示子网掩码时，若IP地址为192.168.153.15，其对应的子网掩码为255.255.255.255。）就是一种主机路由。它的意思是整个IP地址的所有位都将参与路由。进行主机路由，意味着要基于主机上网卡上配置的IP地址本身，而不是基于该地址的网络地址部分进行路由。

主机路由多被用于不希望通过网络地址路由的情况（不过，请读者注意，使用主机路由会导致路由表膨大，路由负荷增加，进而造成网络性能下降。）。

#### 环回地址
环回地址是在同一台计算机上的程序之间进行网络通信时所使用的
一个默认地址。计算机使用一个特殊的IP地址127.0.0.1作为环回地址。
与该地址具有相同意义的是一个叫做localhost的主机名。使用这个IP或
主机名时，数据包不会流向网络。

### 路由控制表聚合
能够缩小路由表的大小是路由控制表聚合最大的优势。路由表越大，管理它所需要的内存和CPU也就越多。并且查找路由表的时间也会越长，导致转发IP数据包的性能下降。如果想要构建大规模、高性能网络，则需要尽可能削减路由表的大小。

<img src=".//4/11.png" width="80%">

## IP分割与再构成处理
### 数据链路，MTU不同
每种数据链路的最大传输单元（MTU）都不尽相同。每种数据链路的MTU之所以不同，是因为每个不同类型的数据链路的使用目的不同。使用目的不同，可承载的MTU也就不同。鉴于IP属于数据链路上一层，它必须不受限于不同数据链路的MTU大小。IP抽象化了底层的数据链路。

### IP报文的分片与重组
任何一台主机都有必要对IP分片（IP Fragmentation）进行相应的处理。分片往往在网络上遇到比较大的报文无法一下子发送出去时才会进行处理。

经过分片之后的IP数据报在被重组的时候，只能由目标主机进行。路由器虽然做分片但不会进行重组。

这样的处理是由诸多方面的因素造成的。例如，现实当中无法保证IP数据报是否经由同一个路径传送。因此，途中即使等待片刻，数据包也有可能无法到达目的地。此外，拆分之后的每个分片也有可能会在途中丢失。即使在途中某一处被重新组装，但如果下一站再经过其他路由时还会面临被分片的可能。这会给路由器带来多余的负担，也会降低网络传送效率。

<img src=".//4/12.png" width="80%">

### 路径MTU发现
所谓路径MTU（Path MTU）是指从发送端主机到接收端主机之间不需要分片时最大MTU的大小。即路径中存在的所有数据链路中最小的MTU。而路径MTU发现从发送主机按照路径MTU的大小将数据报分片后进行发送。进行路径MTU发现，就可以避免在中途的路由器上进行分片处理，也可以在TCP中发送更大的包。

<img src=".//4/13.png" width="80%">

<img src=".//4/14.png" width="80%">

