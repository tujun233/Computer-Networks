# 应用协议
## 应用层协议概要
利用网络的应用程序有很多，包括Web 浏览器、电子邮件、远程登录、文件传输、网络管理等。能够让这些应用进行特定通信处理的正是应用协议。

TCP和IP等下层协议是不依赖于上层应用类型、适用性非常广的协议。而应用协议则是为了实现某种应用而设计和创造的协议。

TCP/IP的应用层涵盖了OSI参考模型中第5、第6、第7层的所有功能，不仅包含了管理通信连接的会话层功能、转换数据格式的表示层功能，还包括与对端主机交互的应用层功能在内的所有功能。

## 远程登陆
远程登录是为了实现TSS（TSS（Time Sharing System）分时系统）环境，是将主机和终端的关系应用到计算机网络上的一个结果。TSS中通常有一个处理能力非常强的主机，围绕着这台主机的是处理能力没有那么强的多个终端机器。这些终端通过专线与主机相连。

类似地，实现从自己的本地计算机登录到网络另一端计算功能的应用就叫做远程登录。通过远程登录到通用计算机或UNIX工作站以后，不仅可以直接使用这些主机上的应用，还可以对这些计算机进行参数设置。远程登录主要使用TELNET和SSH（Secure SHell。）两种协议。

### TELNET
TELNET利用TCP的一条连接，通过这一条连接向主机发送文字命令并在主机上执行。本地用户好像直接与远端主机内部的Shell相连着似的，直接在本地进行操作。

TELNET可以分为两类基本服务。一是仿真终端功能，二是协商选项机制。

<img src=".//8/1.png" width="80%">

TELNET经常用于登录路由器或高性能交换机等网络设备进行相应的设置，通过TELNET登录主机或路由器等设备时需要将自己的登录用户名和密码注册到服务端。

#### 选项
TELNET中除了处理用户所输入的文字外，还提供选项的交互和协商功能。例如，为实现仿真终端（NVT，Network Virtual Terminal）所用到的界面控制信息就是通过选项功能发送出去的。而且，如图所示TELNET中的行模式或透明模式两种模式的设置，也是通过TELNET客户端与TELNET服务端之间的选项功能进行设置的。

<img src=".//8/2.png" width="80%">

#### TELNET客户端
所谓TELNET客户端是指利用TELNET协议实现远程登录的客户端程序。很多情况下，它的程序名就是telnet命令。TELNET客户端通常与目标主机的23号端口建立连接，并与监听这个端口的服务端程序telnetd进行交互。当然，也可以与其他的TCP端口号连接，只要在该端口上有监听程序能够处理telnet请求即可。在一般的telnet命令中可以按照如下格式指定端口号：

telnet 主机名 TCP端口号

TCP端口号为21时可以连接到FTP应用，为25时可以连接到SMTP，为80时可连接到HTTP，为110时可连接到POP3。如此看来，每个服务器都有相应的端口号在等待连接。

### SSH
SSH是加密的远程登录系统。TELNET中登录时无需输入密码就可以发送，容易造成通信窃听和非法入侵的危险。使用SSH后可以加密通信内容。即使信息被窃听也无法破解所发送的密码、具体命令以及命令返回的结果是什么。

SSH还包括很多非常方便的功能：
1. 更强的认证机制
2. 可以转发文件
3. 可以使用端口转发功能

端口转发是指将特定端口号所收到的消息转发到特定的IP地址和端口号码的一种机制。由于经过SSH连接的那部分内容被加密，确保了信息安全，提供了更为灵活的通信。

<img src=".//8/3.png" width="80%">

## 文件传输
FTP是在两个相连的计算机之间进行文件传输时使用的协议。在上一节中，我们已经讲过“远程登录”的概念，FTP中也需要在登录到对方的计算机后才能进行相应的操作。

### FTP工作机制概要
FTP是通过怎样的机制才得以实现文件传输的呢？它使用两条TCP连接：一条用来控制，另一条用于数据（文件）的传输。

用于控制的TCP连接主要在FTP的控制部分使用。例如登录用户名和密码的验证、发送文件的名称、发送方式的设置。利用这个连接，可以通过ASCII码字符串发送请求和接收应答（如表所示）。在这个连接上无法发送数据，数据需要一个专门的TCP进行连接。

FTP控制用的连接使用的是TCP21号端口。在TCP21号端口上进行文件GET（RETR）、PUT（STOR）、以及文件一览（LIST）等操作时，每次都会建立一个用于数据传输的TCP连接。数据的传输和文件一览表的传输正是在这个新建的连接上进行。当数据传送完毕之后，传输数据的这条连接也会被断开，然后会在控制用的连接上继续进行命令或应答的处理。

数据传输用的TCP连接通常使用端口20。不过可以用PORT命令修改为其他的值。最近，出于安全的考虑，普遍在数据传输用的端口号中使用随机数进行分配。

<img src=".//8/4.png" width="80%">

### ASCII码字符串交互处理
FTP中请求命令中使用着“RETR”等ASCII码字符串。而针对这些命令的应答则使用如“200”等3位数字的ASCII码字符串。TCP/IP的应用协议中有很多使用这种ASCII码字符串的协议。

对于ASCII码字符串型的协议来说换行具有重要意义。很多情况下，一行字符串表示一个命令或一个应答，而空白则用来标识与参数之间的分割符。即，命令和应答的消息通过换行区分、参数用空格区分。换行由“CR”（ASCII码的十进制数为13）和“LF”（ASCII码的十进制数为10）两个控制符号组成。

<img src=".//8/5.png" width="80%">

<img src=".//8/6.png" width="80%">

<img src=".//8/7.png" width="80%">

## 电子邮件
### 电子邮件工作机制
提供电子邮件服务的协议叫做SMTP（Simple Mail TransferProtocol）。SMTP为了实现高效发送邮件内容，在其传输层使用了TCP协议。

<img src=".//8/8.png" width="80%">

现在的电子邮件发送过程，改变了以往直接在发送端与接收端主机之间建立TCP连接的机制，而引进了一种一直会连接电源的邮件服务器。发送和接收端通过邮件服务器进行收发邮件。接收端从邮件服务器接收邮件时使用POP3（Post Office Protocol）协议。

电子邮件的机制由3部分组成，它们分别是邮件地址，数据格式以及发送协议。

### 邮件地址
使用电子邮件时需要拥有的地址叫做邮件地址。它就相当于通信地址和姓名。互联网中电子邮件地址的格式如下：

名称@通信地址

例如，master@tcpip.kusa.ac.jp中的master为名称，tcpip.kusa.ac.jp为地址。电子邮件的地址和域名的构造相同。此处，kusa.ac.jp表示域名，tcpip则表示master接收邮件的主机名称或为发送邮件所用的子网名称。现在个人邮件地址和邮件组的格式完全相同，因此，光从地址上是无法区分个人电子邮件地址和邮件组的。

现在，电子邮件的发送地址由DNS进行管理。DNS中注册有邮件地址及其作为发送地址时对应的邮件服务器的域名。这些映射信息被称作MX记录。例如，kusa.ac.jp的MX（Mail Exchange）记录中指定了mailserver.kusa.ac.jp。于是任何发给以kusa.ac.jp结尾的地址的邮件都将被发送到mailserver.kusa.ac.jp服务器。就这样，根据MX记录中指定的邮件服务器，可以管理不同邮件地址与特定邮件服务器之间的映射关系。

### MIME
很长一段时间里，互联网中的电子邮件只能处理文本格式的（由文字组成的信息。过去的电子邮件，就日本来说人们只能发送7比特 JIS编码的信息。）邮件。不过现在，电子邮件所能发送的数据类型已被扩展到MIME（Multipurpose Internet Mail Extensions，广泛用于互联网并极大地扩展了数据格式，还可以用于WWW和NetNews中。），可以发送静态图像、动画、声音、程序等各种形式的数据。鉴于MIME规定了应用消息的格式，因此在OSI参考模型中它相当于第6层表示层。

MIME基本上由首部和正文（数据）两部分组成。首部不能是空行，因为一旦出现空行，其后的部分将被视为正文（数据）。如果MIME首部的“Content-Type”中指定“Multipart/Mixed”，并以“boundary=”后面字符作为分隔符（boundary=后面的字符串，开头一定要写--。而且，间隔符后面也一定要写--），那么可以将多个MIME消息组合成为一个MIME消息。这就叫做multipart。即，各个部分都由MIME首部和正文（数据）组成。

<img src=".//8/9.png" width="80%">

<img src=".//8/10.png" width="80%">

### SMTP
SMTP是发送电子邮件的协议。它使用的是TCP的25号端口。SMTP建立一个TCP连接以后，在这个连接上进行控制和应答以及数据的发送。客户端以文本的形式发出请求，服务端返回一个3位数字的应答。每个指令和应答的最后都必须追加换行指令（CR、LF）。

<img src=".//8/11.png" width="80%">

<img src=".//8/12.png" width="80%">

<img src=".//8/13.png" width="80%">

### POP
个人电脑不可能长时间处于开机状态。只有用户在使用时才会开机。在这种情况下，人们希望一开机就能接收到邮件。然而SMTP没有这种处理机制。SMTP的一个不利之处就在于它支持的是发送端主机的行为，而不是根据接收端的请求发送邮件。

为了解决这个问题，就引入了POP协议。如图所示，该协议是一种用于接收电子邮件的协议。发送端的邮件根据SMTP协议将被转发给一直处于插电状态的POP服务器。客户端再根据POP协议从POP服务器接收对方发来的邮件。在这个过程中，为了防止他人盗窃邮件内容，还要进行用户验证。

<img src=".//8/14.png" width="80%">

POP与SMTP一样，也是在其客户端与服务器之间通过建立一个TCP连接完成相应操作。POP的具体命令和相关应答代码如表所示。它的命令都是较短的ASCII码字符串，应答更是极其简单，只有两种。正常的情况下为“+OK”，发生错误或异常的情况下为“-ERR”。

<img src=".//8/15.png" width="80%">

<img src=".//8/16.png" width="80%">

