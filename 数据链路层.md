# 数据链路层
## 数据链路的作用
数据链路，指OSI参考模型中的数据链路层，有时也指以太网、无线局域网等通信手段。

数据链路层的协议定义了通过通信媒介互连的设备之间传输的规范。通信媒介包括双绞线电缆、同轴电缆、光纤、电波以及红外线等介质。此外，各个设备之间有时也会通过交换机、网桥、中继器等中转数据。

数据链路层处理的数据也不是单纯的0、1序列，该层把它们集合为一个叫做“**帧**”的块，然后再进行传输。

## 数据链路相关技术
### MAC地址
MAC地址用于识别数据链路中互连的节点（如图）。

<img src=".//3/1.png" width="80%">

以太网、无线LAN、蓝牙等设备中也是用相同规格的MAC地址。

MAC地址长**48比特**，结构如图所示。在使用网卡（NIC）的情况下，MAC地址一般会被烧入到ROM中。因此，任何一个网卡的MAC地址都是唯一的，在全世界都不会有重复。

***用十六进制表示MAC地址，在比特流中需要反过来。***

<img src=".//3/2.png" width="80%">

MAC地址中3～24位（比特位）表示**厂商识别码**，每个NIC厂商都有特定唯一的识别数字。25～48位是**厂商内部为识别每个网卡**而用。因此，可以保证全世界不会有相同MAC地址的网卡。

### 共享介质型网络
共享介质型网络指由多个设备共享一个通信介质的一种网络。最早的以太网和FDDI就是介质共享型网络。在这种方式下，设备之间使用同一个载波信道进行发送和接收。为此，基本上采用半双工通信方式，并有必要对介质进行访问控制。

共享介质型网络中有两种介质访问控制方式：一种是**争用方式**，另一种是**令牌传递方式**。

#### 争用方式
争用方式也叫载波监听多路访问（CSMA）。网络中的各个站采用先到先得方式占用信道。如果多个站同时发送，会发生冲突。

<img src=".//3/3.png" width="80%">

在一部分以太网中采用了改良的CSMA方式：CSMA/CD (Carrier Sense Multiple Access with Collision Detection)。CSMA/CD要求每个站检查冲突，具体工作原理如下：

<img src=".//3/4.png" width="80%">

#### 令牌传递方式

令牌传递方式是沿着令牌环发送一种叫做“**令牌**”的特殊报文，是控制传输的一种方式。只有获得令牌的站才能发送数据。这种方式有两个特点：一是不会有冲突，二是每个站都有通过平等循环获得令牌的机会。因此，即使网络拥堵也不会导致性能下降。

当然，这种方式中，一个站在没有收到令牌前不能发送数据帧，因此在网络不太拥堵的情况下数据链路的利用率也就达不到100％。为此，衍生了多种令牌传递的技术。例如，早期令牌释放、令牌追加（不等待接收方的数据到达确认就将令牌发送给下一个站。） 等方式以及多个令牌同时循环等方式。这些方式的目的都是为了尽可能地提高网络性能。

<img src=".//3/5.png" width="80%">

### 非共享介质型网络
非共享介质网络是指不共享介质，是对介质采取专用的一种传输控制方式。在这种方式下，网络中的每个站直连交换机，由交换机负责转发数据帧。此方式下，发送端与接收端并不共享通信介质，因此很多情况下采用全双工通信方式。

该方式还可以根据交换机的高级特性构建虚拟局域网（VLAN，Virtual LAN）、进行流量控制等。当然，这种方式也有一个**致命的弱点**，那就是一旦交换机发生故障，与之相连的所有计算机之间都将无法通信。

### 根据MAC地址转发
以太网交换机就是持有多个端口的网桥。它们根据数据链路层中每个帧的目标MAC地址，决定从哪个网络接口发送数据。这时所参考的、用以记录发送接口的表就叫做**转发表**（Forwarding Table）。

这种转发表的内容不需要使用者在每个终端或交换机上手工设置，而是可以自动生成。数据链路层的每个通过点在接到包时，会从中将源MAC地址以及曾经接收该地址发送的数据包的接口作为对应关系记录到转发表中。这一过程也叫自学过程。

<img src=".//3/6.png" width="80%">

### 环路检测技术
通过网桥连接网络时，一旦出现环路该如何处理？这与网络的拓扑结构和所使用的网桥种类有直接关系。最坏的情况下，数据帧会在环路中被一而再再而三地持续转发。而一旦这种数据帧越积越多将会导致网络瘫痪。

为此，有必要解决网络中的环路问题。具体有**生成树**与**源路由**两种方式。如果使用具有这些功能的网桥，那么即使构建了一个带有环路的网络，也不会造成那么严重的问题。只要搭建合适的环路，就能分散网络流量，在发生某一处路由故障时选择绕行，可以提高容灾能力。

#### 生成树方式
该方法由IEEE802.1D定义。每个网桥必须在每1～10秒内相互交换BPDU（Bridge Protocol Data Unit）包，从而判断哪些端口使用哪些不使用，以便消除环路。一旦发生故障，则自动切换通信线路，利用那些没有被使用的端口继续进行传输。

#### 源路由方法
**不太会，之后再补**

### VLAN
VLAN（Virtual Local Area Network）即虚拟局域网，是将一个物理的LAN在逻辑上划分成多个广播域的通信技术。每个VLAN是一个广播域，VLAN内的主机间可以直接通信，而VLAN间则不能直接互通。这样，广播报文就被限制在一个VLAN内。

<img src=".//3/7.png" width="80%">

如图所示，该交换机按照其端口区分了多个网段，从而区分了广播数据传播的范围、减少了网络负载并提高了网络的安全性。

对这种VLAN进行了扩展，又定义了IEEE802.1Q的标准（也叫TAG VLAN），该标准允许包含跨越异构交换机的网段。TAG VLAN中对每个网段都用一个VLAN ID的标签进行唯一标识。在交换机中传输帧时，在以太网首部加入这个VID 标签，根据这个值决定将数据帧发送给哪个网段。

<img src=".//3/8.png" width="80%">

## 以太网
在以太网普及之初，一般采用多台终端使用同一根同轴电缆的共享介质型连接方式。而现在，随着互连设备的处理能力以及传输速度的提高，一般都采用终端与交换机之间独占电缆的方式实现以太网通信。

<img src=".//3/9.png" width="80%" >

初期以太网结构

<img src=".//3/10.png" width="80%">

现代以太网结构

### 以太网分类
以太网因通信电缆的不同及通信速度的差异，衍生出了众多不同的以太网类型。

<img src=".//3/11.png" width="80%">

10BASE中的“10”、100BASE中的“100”、1000BASE中的“1000”以及10GBASE中的“10G”分别指10Mbps、100Mbps、1Gbps以及10Gbps的传输速度。而追加于后面的“5”、“2”、“T”、“F”等字符表示的是传输介质。在传输速度相同而传输所用电缆不同的情况下，可以连接那些允许更换传输介质的中继器或集线器。而在传输速度不同的情况下，则必须采用那些允许变更速度的设备如网桥、交换集线器或路由器。

### 以太网帧格式
以太网帧前端有一个叫做前导码（Preamble）的部分，它由0、1数字交替组合而成，表示一个以太网帧的开始，也是对端网卡能够确保与其同步的标志。如图所示。前导码末尾是一个叫做SFD（Start Frame Delimiter）的域，它的值是“11”。在这个域之后就是以太网帧的本体。前导码与SFD合起来占8个字节

<img src=".//3/12.png" width="80%">

以太网帧本体的前端是以太网的首部，它总共占14个字节。分别是6个字节的**目标MAC地址**、6个字节的**源MAC地址**以及2个字节的**上层协议类型**。

<img src=".//3/13.png" width="80%">

紧随帧头后面的是数据。一个数据帧所能容纳的最大数据范围是46～1500个字节。帧尾是一个叫做**FCS**（Frame Check Sequence，帧检验序列）的4个字节。

类型通常跟数据一起传送，它包含用以标识协议类型的编号，即表明以太网的再上一层网络协议的类型，比如IP、ARP等。

IEEE802.3 Ethernet与一般的以太网在帧的首部上稍有区别。一般以太网帧中表示类型的字段，在IEEE802.3以太网中却表示帧的长度。此外，数据部分的前端还有LLC和SNAP等字段。而标识上一层协议类型的字段就出现在这个SNAP中。不过SNAP中指定的协议类型与一般以太网协议类型的意思基本相同。

## 无线通信
无线通信通常使用电磁波、红外线、激光等方式进行传播数据。一般在办公室的局域网范围内组成的较高速的连接称为无线局域网。

## PPP
PPP（Point-to-Point Protocol）是指点对点，即1对1连接计算机的协议。PPP相当于位于OSI参考模型第2层的数据链路层。

<img src=".//3/14.png" width="80%">

在PPP的主要功能中包括两个协议：一个是不依赖上层的LCP协议（Link Control Protocol），另一个是依赖上层的NCP协议（Network Control Protocol）。如果上层为IP，此时的NCP也叫做IPCP（IP Control Protocol）。

LCP主要负责建立和断开连接、设置最大接收单元（MRU，Maximum Receive Unit）、设置验证协议（PAP或CHAP）以及设置是否进行通信质量的监控。而IPCP则负责IP地址设置以及是否进行TCP/IP首部压缩等设备（设备之间的这种交互也叫协商（Negotiation）。）

<img src=".//3/15.png" width="80%">

### PPP帧格式
PPP的数据帧格式如图3.26所示。其中**标志码**用来区分每个帧。这一点与HDLC（HDLC High Level Data Link Control Procedure，高级数据链路控制。） 协议非常相似，因为PPP本身就是基于HDLC制定出来的一种协议。

HDLC就是在每个帧的前后加上一个8位字节“01111110”用来区分帧。这一个8位字节叫做**标志码**。在两个标志码中间不允许出现连续**6**个以上的“1”。因此，在发送帧的时候，当出现连续5个“1”时后面必须插入一个0。而当接收端在接收帧时，如果收到连续的5个“1”且后面跟着的是0，就必须删除。由于最多只会出现5个连续的“1”，就可以比较容易地通过标志码区分帧的起始与终止。而PPP标准帧格式与此完全相同。

<img src=".//3/16.png" width="80%">



